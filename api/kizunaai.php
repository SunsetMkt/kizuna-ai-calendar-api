<?php
header("Access-Control-Allow-Origin: *"); //cors，允许一切引用
error_reporting(0); //禁止报错
/*
     * 绊爱日历项目服务器API
     * 参数：id = 63045280 Bilbili原作者ID
     *     date = MM-DD格式，不需要与服务器时间相同 例如01-01 02-22 12-31
     * API返回值：用于直接获取OSS（对象存储服务，可以理解为网盘）上文件的URL，纯文本
     * 作者：灰暗江原 & lwd-temp
     * 日期：2022-03-01
    */

/*
    error-00   没有请求id
    error-01   请求id不存在
    error-02   数据错误
    error-03   无数据
    */

//文件结构json，注意是字符串
//生产环境记得换上真的
$file_struct_str = '{"01-01": ["1.mp4"], "01-02": ["1.mp4", "2.mp4"], "01-03": ["1.mp4", "2.mp4"], "01-04": ["1.mp4", "2.mp4"], "01-05": ["1.mp4", "2.mp4"], "01-06": ["1.mp4", "2.mp4"], "01-07": ["1.mp4", "2.mp4"], "01-08": ["1.mp4", "2.mp4"], "01-09": ["1.mp4", "2.mp4"], "01-10": ["1.mp4", "2.mp4"], "01-11": ["1.mp4", "2.mp4"], "01-12": ["1.mp4"], "01-13": ["1.mp4", "2.mp4"], "01-14": ["1.mp4", "2.mp4"], "01-15": ["1.mp4", "2.mp4"], "01-16": ["1.mp4", "2.mp4"], "01-17": ["1.mp4", "2.mp4"], "01-18": ["1.mp4", "2.mp4"], "01-19": ["1.mp4", "2.mp4"], "01-20": ["1.mp4"], "01-21": ["1.mp4", "2.mp4"], "01-22": ["1.mp4", "2.mp4"], "01-23": ["1.mp4", "2.mp4"], "01-24": ["1.mp4", "2.mp4"], "01-25": ["1.mp4", "2.mp4"], "01-26": ["1.mp4", "2.mp4"], "01-27": ["1.mp4", "2.mp4"], "01-28": ["1.mp4", "2.mp4"], "01-29": ["1.mp4", "2.mp4"], "01-30": ["1.mp4", "2.mp4"], "01-31": ["1.mp4", "2.mp4"], "02-01": ["1.mp4", "2.mp4"], "02-02": ["1.mp4", "2.mp4"], "02-03": ["1.mp4", "2.mp4"], "02-04": ["1.mp4", "2.mp4"], "02-05": ["1.mp4", "2.mp4"], "02-06": ["1.mp4", "2.mp4"], "02-07": ["1.mp4", "2.mp4"], "02-08": ["1.mp4", "2.mp4"], "02-09": ["1.mp4", "2.mp4"], "02-10": ["1.mp4", "2.mp4"], "02-11": ["1.mp4", "2.mp4"], "02-12": ["1.mp4", "2.mp4"], "02-13": ["1.mp4", "2.mp4"], "02-14": ["1.mp4", "2.mp4"], "02-15": ["1.mp4", "2.mp4"], "02-16": ["1.mp4", "2.mp4"], "02-17": ["1.mp4", "2.mp4"], "02-18": ["1.mp4", "2.mp4"], "02-19": ["1.mp4", "2.mp4"], "02-20": ["1.mp4", "2.mp4"], "02-21": ["1.mp4", "2.mp4"], "02-22": ["1.mp4", "2.mp4"], "02-23": ["1.mp4", "2.mp4"], "02-24": ["1.mp4", "2.mp4"], "02-25": ["1.mp4", "2.mp4"], "02-26": ["1.mp4", "2.mp4"], "02-27": ["1.mp4"], "02-28": ["1.mp4"], "03-01": ["1.mp4"], "03-02": ["1.mp4"], "03-03": ["1.mp4"], "03-04": ["1.mp4"], "03-05": ["1.mp4"], "03-06": ["1.mp4"], "03-07": ["1.mp4"], "03-08": ["1.mp4"], "03-09": ["1.mp4"], "03-10": ["1.mp4"], "03-11": ["1.mp4"], "03-12": ["1.mp4"], "03-13": ["1.mp4"], "03-14": ["1.mp4"], "03-15": ["1.mp4"], "03-16": ["1.mp4"], "03-17": ["1.mp4"], "03-19": ["1.mp4"], "03-20": ["1.mp4"], "03-21": ["1.mp4"], "03-22": ["1.mp4"], "03-23": ["1.mp4"], "03-24": ["1.mp4"], "03-25": ["1.mp4"], "03-26": ["1.mp4"], "03-27": ["1.mp4"], "03-28": ["1.mp4"], "03-29": ["1.mp4"], "03-30": ["1.mp4"], "03-31": ["1.mp4"], "04-01": ["1.mp4", "2.mp4"], "04-02": ["1.mp4"], "04-03": ["1.mp4", "2.mp4"], "04-04": ["1.mp4"], "04-05": ["1.mp4"], "04-06": ["1.mp4", "2.mp4"], "04-07": ["1.mp4", "2.mp4"], "04-08": ["1.mp4", "2.mp4"], "04-09": ["1.mp4", "2.mp4"], "04-10": ["1.mp4", "2.mp4"], "04-11": ["1.mp4", "2.mp4"], "04-12": ["1.mp4", "2.mp4"], "04-13": ["1.mp4", "2.mp4"], "04-14": ["1.mp4", "2.mp4"], "04-15": ["1.mp4", "2.mp4"], "04-16": ["1.mp4", "2.mp4"], "04-17": ["1.mp4", "2.mp4"], "04-18": ["1.mp4", "2.mp4"], "04-19": ["1.mp4", "2.mp4"], "04-20": ["1.mp4", "2.mp4"], "04-21": ["1.mp4", "2.mp4"], "04-22": ["1.mp4", "2.mp4"], "04-23": ["1.mp4", "2.mp4"], "04-24": ["1.mp4", "2.mp4"], "04-25": ["1.mp4", "2.mp4"], "04-26": ["1.mp4", "2.mp4"], "04-27": ["1.mp4", "2.mp4"], "04-28": ["1.mp4", "2.mp4"], "04-29": ["1.mp4", "2.mp4"], "04-30": ["1.mp4", "2.mp4"], "05-01": ["1.mp4", "2.mp4"], "05-02": ["1.mp4", "2.mp4"], "05-03": ["1.mp4", "2.mp4"], "05-04": ["1.mp4", "2.mp4"], "05-05": ["1.mp4", "2.mp4"], "05-06": ["1.mp4", "2.mp4"], "05-07": ["1.mp4", "2.mp4"], "05-08": ["1.mp4", "2.mp4"], "05-09": ["1.mp4", "2.mp4"], "05-10": ["1.mp4", "2.mp4"], "05-11": ["1.mp4", "2.mp4"], "05-12": ["1.mp4"], "05-13": ["1.mp4", "2.mp4"], "05-14": ["1.mp4", "2.mp4"], "05-15": ["1.mp4", "2.mp4"], "05-16": ["1.mp4", "2.mp4"], "05-17": ["1.mp4", "2.mp4"], "05-18": ["1.mp4", "2.mp4"], "05-19": ["1.mp4"], "05-20": ["1.mp4", "2.mp4"], "05-21": ["1.mp4", "2.mp4"], "05-22": ["1.mp4", "2.mp4"], "05-23": ["1.mp4", "2.mp4"], "05-24": ["1.mp4", "2.mp4"], "05-25": ["1.mp4", "2.mp4"], "05-26": ["1.mp4", "2.mp4"], "05-27": ["1.mp4", "2.mp4"], "05-28": ["1.mp4", "2.mp4"], "05-29": ["1.mp4", "2.mp4"], "05-30": ["1.mp4", "2.mp4"], "05-31": ["1.mp4", "2.mp4"], "06-01": ["1.mp4", "2.mp4"], "06-02": ["1.mp4", "2.mp4"], "06-03": ["1.mp4", "2.mp4"], "06-04": ["1.mp4"], "06-05": ["1.mp4", "2.mp4"], "06-06": ["1.mp4", "2.mp4"], "06-07": ["1.mp4", "2.mp4"], "06-08": ["1.mp4", "2.mp4"], "06-09": ["1.mp4", "2.mp4"], "06-10": ["1.mp4", "2.mp4"], "06-11": ["1.mp4", "2.mp4"], "06-12": ["1.mp4", "2.mp4"], "06-13": ["1.mp4", "2.mp4"], "06-14": ["1.mp4"], "06-15": ["1.mp4"], "06-16": ["1.mp4"], "06-17": ["1.mp4"], "06-18": ["1.mp4"], "06-19": ["1.mp4"], "06-20": ["1.mp4"], "06-21": ["1.mp4", "2.mp4"], "06-22": ["1.mp4", "2.mp4"], "06-23": ["1.mp4", "2.mp4"], "06-24": ["1.mp4", "2.mp4"], "06-25": ["1.mp4", "2.mp4"], "06-26": ["1.mp4", "2.mp4"], "06-27": ["1.mp4", "2.mp4"], "06-28": ["1.mp4", "2.mp4"], "06-29": ["1.mp4", "2.mp4"], "06-30": ["1.mp4", "2.mp4"], "07-01": ["1.mp4", "2.mp4"], "07-02": ["1.mp4", "2.mp4"], "07-03": ["1.mp4", "2.mp4"], "07-04": ["1.mp4", "2.mp4"], "07-05": ["1.mp4", "2.mp4"], "07-06": ["1.mp4", "2.mp4"], "07-07": ["1.mp4"], "07-08": ["1.mp4", "2.mp4"], "07-09": ["1.mp4", "2.mp4"], "07-10": ["1.mp4", "2.mp4"], "07-11": ["1.mp4", "2.mp4"], "07-12": ["1.mp4", "2.mp4"], "07-13": ["1.mp4", "2.mp4"], "07-14": ["1.mp4", "2.mp4"], "07-15": ["1.mp4", "2.mp4"], "07-16": ["1.mp4", "2.mp4"], "07-17": ["1.mp4", "2.mp4"], "07-18": ["1.mp4", "2.mp4"], "07-19": ["1.mp4", "2.mp4"], "07-20": ["1.mp4", "2.mp4"], "07-21": ["1.mp4"], "07-22": ["1.mp4", "2.mp4"], "07-23": ["1.mp4", "2.mp4"], "07-24": ["1.mp4", "2.mp4"], "07-25": ["1.mp4", "2.mp4"], "07-26": ["1.mp4", "2.mp4"], "07-27": ["1.mp4", "2.mp4"], "07-28": ["1.mp4", "2.mp4"], "07-29": ["1.mp4", "2.mp4"], "07-30": ["1.mp4", "2.mp4"], "07-31": ["1.mp4", "2.mp4"], "08-01": ["1.mp4", "2.mp4"], "08-02": ["1.mp4", "2.mp4"], "08-03": ["1.mp4", "2.mp4"], "08-04": ["1.mp4", "2.mp4"], "08-05": ["1.mp4", "2.mp4"], "08-06": ["1.mp4", "2.mp4"], "08-07": ["1.mp4", "2.mp4"], "08-08": ["1.mp4", "2.mp4"], "08-09": ["1.mp4", "2.mp4"], "08-10": ["1.mp4", "2.mp4"], "08-11": ["1.mp4", "2.mp4"], "08-12": ["1.mp4", "2.mp4"], "08-13": ["1.mp4", "2.mp4"], "08-14": ["1.mp4", "2.mp4"], "08-15": ["1.mp4", "2.mp4"], "08-16": ["1.mp4", "2.mp4"], "08-17": ["1.mp4", "2.mp4"], "08-18": ["1.mp4", "2.mp4"], "08-19": ["1.mp4", "2.mp4"], "08-20": ["1.mp4", "2.mp4"], "08-21": ["1.mp4", "2.mp4"], "08-22": ["1.mp4", "2.mp4"], "08-23": ["1.mp4", "2.mp4"], "08-24": ["1.mp4", "2.mp4"], "08-25": ["1.mp4", "2.mp4"], "08-26": ["1.mp4", "2.mp4"], "08-27": ["1.mp4", "2.mp4"], "08-28": ["1.mp4", "2.mp4"], "08-29": ["1.mp4", "2.mp4"], "08-30": ["1.mp4", "2.mp4"], "08-31": ["1.mp4", "2.mp4"], "09-01": ["1.mp4", "2.mp4"], "09-02": ["1.mp4", "2.mp4"], "09-03": ["1.mp4", "2.mp4"], "09-04": ["1.mp4", "2.mp4"], "09-05": ["1.mp4", "2.mp4"], "09-06": ["1.mp4", "2.mp4"], "09-07": ["1.mp4", "2.mp4"], "09-08": ["1.mp4", "2.mp4"], "09-09": ["1.mp4", "2.mp4"], "09-10": ["1.mp4", "2.mp4"], "09-11": ["1.mp4", "2.mp4"], "09-12": ["1.mp4", "2.mp4"], "09-13": ["1.mp4", "2.mp4"], "09-14": ["1.mp4", "2.mp4"], "09-15": ["1.mp4", "2.mp4"], "09-16": ["1.mp4", "2.mp4"], "09-17": ["1.mp4", "2.mp4"], "09-19": ["1.mp4", "2.mp4"], "09-20": ["1.mp4", "2.mp4"], "09-21": ["1.mp4", "2.mp4"], "09-22": ["1.mp4", "2.mp4"], "09-23": ["1.mp4", "2.mp4"], "09-24": ["1.mp4", "2.mp4"], "09-25": ["1.mp4", "2.mp4"], "09-26": ["1.mp4", "2.mp4"], "09-27": ["1.mp4", "2.mp4"], "09-28": ["1.mp4"], "09-29": ["1.mp4", "2.mp4"], "09-30": ["1.mp4", "2.mp4"], "10-01": ["1.mp4", "2.mp4"], "10-02": ["1.mp4", "2.mp4"], "10-03": ["1.mp4", "2.mp4"], "10-04": ["1.mp4", "2.mp4"], "10-05": ["1.mp4", "2.mp4"], "10-06": ["1.mp4", "2.mp4"], "10-07": ["1.mp4", "2.mp4"], "10-08": ["1.mp4", "2.mp4"], "10-09": ["1.mp4", "2.mp4"], "10-10": ["1.mp4", "2.mp4"], "10-11": ["1.mp4", "2.mp4"], "10-12": ["1.mp4", "2.mp4"], "10-13": ["1.mp4", "2.mp4"], "10-14": ["1.mp4", "2.mp4"], "10-15": ["1.mp4", "2.mp4"], "10-16": ["1.mp4", "2.mp4"], "10-17": ["1.mp4", "2.mp4"], "10-18": ["1.mp4", "2.mp4"], "10-19": ["1.mp4", "2.mp4"], "10-20": ["1.mp4", "2.mp4"], "10-21": ["1.mp4", "2.mp4"], "10-22": ["1.mp4", "2.mp4"], "10-23": ["1.mp4", "2.mp4"], "10-24": ["1.mp4", "2.mp4"], "10-25": ["1.mp4", "2.mp4"], "10-26": ["1.mp4", "2.mp4"], "10-27": ["1.mp4", "2.mp4"], "10-28": ["1.mp4", "2.mp4"], "10-29": ["1.mp4"], "10-30": ["1.mp4", "2.mp4"], "10-31": ["1.mp4"], "11-01": ["1.mp4", "2.mp4"], "11-02": ["1.mp4", "2.mp4"], "11-03": ["1.mp4", "2.mp4"], "11-04": ["1.mp4", "2.mp4"], "11-05": ["1.mp4", "2.mp4"], "11-06": ["1.mp4", "2.mp4"], "11-07": ["1.mp4", "2.mp4"], "11-08": ["1.mp4", "2.mp4"], "11-09": ["1.mp4", "2.mp4"], "11-10": ["1.mp4", "2.mp4"], "11-11": ["1.mp4", "2.mp4"], "11-12": ["1.mp4", "2.mp4"], "11-13": ["1.mp4", "2.mp4"], "11-14": ["1.mp4", "2.mp4"], "11-15": ["1.mp4", "2.mp4"], "11-16": ["1.mp4", "2.mp4"], "11-17": ["1.mp4", "2.mp4"], "11-18": ["1.mp4", "2.mp4"], "11-19": ["1.mp4", "2.mp4"], "11-20": ["1.mp4", "2.mp4"], "11-21": ["1.mp4", "2.mp4"], "11-22": ["1.mp4", "2.mp4"], "11-23": ["1.mp4", "2.mp4"], "11-24": ["1.mp4", "2.mp4"], "11-25": ["1.mp4", "2.mp4"], "11-26": ["1.mp4", "2.mp4"], "11-27": ["1.mp4", "2.mp4"], "11-28": ["1.mp4", "2.mp4"], "11-29": ["1.mp4", "2.mp4"], "11-30": ["1.mp4", "2.mp4"], "12-01": ["1.mp4", "2.mp4"], "12-02": ["1.mp4", "2.mp4"], "12-03": ["1.mp4", "2.mp4"], "12-04": ["1.mp4", "2.mp4"], "12-05": ["1.mp4", "2.mp4"], "12-06": ["1.mp4", "2.mp4"], "12-07": ["1.mp4", "2.mp4"], "12-08": ["1.mp4", "2.mp4"], "12-09": ["1.mp4", "2.mp4"], "12-10": ["1.mp4", "2.mp4"], "12-11": ["1.mp4", "2.mp4"], "12-12": ["1.mp4", "2.mp4"], "12-13": ["1.mp4"], "12-14": ["1.mp4", "2.mp4"], "12-15": ["1.mp4", "2.mp4"], "12-16": ["1.mp4", "2.mp4"], "12-17": ["1.mp4", "2.mp4"], "12-18": ["1.mp4", "2.mp4"], "12-19": ["1.mp4", "2.mp4"], "12-20": ["1.mp4", "2.mp4"], "12-21": ["1.mp4", "2.mp4"], "12-22": ["1.mp4", "2.mp4"], "12-23": ["1.mp4", "2.mp4"], "12-24": ["1.mp4", "2.mp4"], "12-25": ["1.mp4", "2.mp4"], "12-26": ["1.mp4", "2.mp4"], "12-27": ["1.mp4", "2.mp4"], "12-28": ["1.mp4", "2.mp4"], "12-29": ["1.mp4", "2.mp4"], "12-30": ["1.mp4"], "12-31": ["1.mp4", "2.mp4"]}';
//OSS基础URL前部分
$oss_base_url_a = 'https://drive.lwd-temp.top/api?path=';
//OSS基础URL后部分
$oss_base_url_b = '&raw=true';
//OSS从根目录起的基础目录路径
$dir = '/KizunaAI';
//日期验证正则，MM-DD
$date_regex = '/^(0[1-9]|1[012])[\-\/.](0[1-9]|[12][0-9]|3[01])$/';

//json转数组（多维数组）
$file_struct = json_decode($file_struct_str, true);

date_default_timezone_set('Asia/Shanghai'); //设置默认时区，不必要
//判断是否存在请求
if (isset($_GET["id"])) {
    $id = $_GET["id"];
    //判断客请求参数id
    //绊爱日历请求id，目前是灰暗江原的UID，唯一的目的是防盗版
    if ($id == "63045280") {
        $client_date = $_GET["date"];
        //判断请求数据是否与日期正则匹配，MM-DD
        if (preg_match($date_regex, $client_date)) {
            try { //这里直接捕捉错误
                if ($client_date == "02-29") {
                    $client_date = "02-28"; //数据库里没有2月29日，把日期设为28日
                }
                $videos = $file_struct[$client_date]; //直接根据日期获取视频列表
                if (count($videos) > 1) //count($new_video)获取数组长度
                {
                    $rand_video = $videos[array_rand($videos)]; //随机获取数组元素
                    $abs_dir = $dir . "/" . $client_date . "/" . $rand_video;
                    $oss_url = $oss_base_url_a . $abs_dir . $oss_base_url_b;
                    echo $oss_url;
                } else {
                    $abs_dir = $dir . "/" . $client_date . "/" . $videos[0];
                    $oss_url = $oss_base_url_a . $abs_dir . $oss_base_url_b;
                    echo $oss_url;
                }
            } catch (\Throwable $th) { //如果出现任何错误
                echo "error-03";
            }
        } else {
            echo "error-02";
        }
    } else {
        echo "error-01";
    }
} else {
    echo "error-00";
}
